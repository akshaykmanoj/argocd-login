pipeline {
    agent any
    parameters {
        string(name: '${build_number}', defaultValue: '', description: 'The build number for this job')
    }
    stages {
        stage('Build') {
            steps {
             echo "${build_number}"
            }
        }
        stage('Update GIT') {
            script {
                catchError(buildResult: 'SUCCESS', stageResult: 'FAILURE') {
                    withCredentials([gitUsernamePassword(credentialsId: 'git-key', gitToolName: 'Default')]){
                        //def encodedPassword = URLEncoder.encode("$GIT_PASSWORD",'UTF-8')
                        sh "git config user.email akshaykmanoj45@gmail.com"
                        sh "git config user.name akshaykmanoj"
                        //sh "git switch master"
                        sh "cat deployment.yaml"
                        sh "sed -i 's|akshaykmanoj/my-django-login:latest|akshaykmanoj/my-django-login:${env.BUILD_NUMBER}|g' deployment.yaml"
                        sh "cat deployment.yaml"
                        sh "git add ."
                        sh "git commit -m 'Done by Jenkins Job changemanifest: ${env.BUILD_NUMBER}'"
                        sh "git push https://github.com/akshaykmanoj/argocd-login.git main"
                        }
                    }
              }
        }
    }
}
